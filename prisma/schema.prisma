generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"

}

enum Role {
  ADMIN
  PROJECT_MANAGER
  ACCOUNTANT
  TEAM_MEMBER
  CONTRACTOR
}

enum ProjectStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PaymentType {
  INCOMING
  OUTGOING
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  
  accounts      Account[]
  sessions      Session[]
  memberships   WorkspaceMember[]
  notifications Notification[]
  comments      Comment[]
  activities    Activity[]
  projectMembers ProjectMember[]
  assignedTasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // For URL friendly identifiers
  description String?
  logo        String?  // URL/path to workspace logo
  address     String?  // Physical or business address
  currency    String   @default("USD")
  ownerId     String   // The user who owns the workspace (usually the creator)

  members     WorkspaceMember[]
  invites     WorkspaceInvite[]
  invitations Invitation[]
  projects    Project[]
  inventory   InventoryItem[]
  invoices    Invoice[]
  contractors Contractor[]
  payments    Payment[]
  documents   Document[]
  tasks       Task[]
  teams       Team[]
  expenses    Expense[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model WorkspaceInvite {
  id          String   @id @default(cuid())
  workspaceId String
  email       String
  role        Role     @default(TEAM_MEMBER)
  token       String   @unique
  expires     DateTime

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([workspaceId, email])
}

model WorkspaceMember {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  role        Role      @default(TEAM_MEMBER)
  joinedAt    DateTime  @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
}

model Project {
  id          String        @id @default(cuid())
  workspaceId String
  name        String
  description String?
  status      ProjectStatus @default(PENDING)
  startDate   DateTime?
  endDate     DateTime?
  budget      Decimal       @default(0) @db.Decimal(15, 2)
  
  // Relations
  workspace   Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  managerId   String?        // Assigned Project Manager (User ID)
  
  allocations InventoryAllocation[]
  invoices    Invoice[]
  milestones  ProjectMilestone[]
  payments    Payment[]
  comments    Comment[]
  activities  Activity[]
  documents   Document[]
  members     ProjectMember[]
  tasks       Task[]
  teams       Team[]
  reminders   Reminder[]


  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([workspaceId])
  @@index([status])
}

model ProjectMilestone {
  id        String   @id @default(cuid())
  projectId String
  title     String
  dueDate   DateTime?
  completed Boolean  @default(false)
  
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model InventoryItem {
  id                String  @id @default(cuid())
  workspaceId       String
  name              String
  sku               String?
  category          String?
  quantity          Int     @default(0)
  unitCost          Decimal @db.Decimal(10, 2)
  lowStockThreshold Int     @default(5)
  image             String?

  workspace   Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  allocations InventoryAllocation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
}

model InventoryAllocation {
  id        String @id @default(cuid())
  itemId    String
  projectId String
  quantity  Int

  item    InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  allocatedAt DateTime @default(now())
}

model Contractor {
  id            String  @id @default(cuid())
  workspaceId   String
  companyName   String
  contactName   String?
  email         String?
  phone         String?
  contractValue Decimal? @db.Decimal(15, 2)

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invoices  Invoice[]
  payments  Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id           String        @id @default(cuid())
  workspaceId  String
  projectId    String?
  contractorId String?
  teamId       String?

  number       String        // Invoice #
  status       InvoiceStatus @default(DRAFT)
  currency     String        @default("USD")
  
  totalAmount    Decimal @db.Decimal(15, 2)
  taxAmount      Decimal @default(0) @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  
  dueDate      DateTime?
  sentAt       DateTime?
  paidAt       DateTime?
  
  recipientName  String?
  recipientEmail String?
  notes          String?

  workspace  Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project    Project?    @relation(fields: [projectId], references: [id])
  contractor Contractor? @relation(fields: [contractorId], references: [id])
  team       Team?       @relation(fields: [teamId], references: [id])
  payments   Payment[]

  items      InvoiceItem[]
  activities Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  description String
  quantity    Int
  unitPrice   Decimal @db.Decimal(15, 2)
  amount      Decimal @db.Decimal(15, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Payment {
  id           String      @id @default(cuid())
  workspaceId  String
  invoiceId    String?
  contractorId String?
  projectId    String?
  teamId       String?

  amount       Decimal     @db.Decimal(15, 2)
  date         DateTime    @default(now())
  type         PaymentType @default(OUTGOING)
  method       String?
  reference    String?

  workspace  Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invoice    Invoice?    @relation(fields: [invoiceId], references: [id])
  contractor Contractor? @relation(fields: [contractorId], references: [id])
  project    Project?    @relation(fields: [projectId], references: [id])
  team       Team?       @relation(fields: [teamId], references: [id])


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("INFO") // INFO, SUCCESS, WARNING, ERROR
  read      Boolean  @default(false)
  link      String?  // Optional link to redirect to (e.g. /projects/123)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  projectId String
  userId    String
  
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Activity {
  id        String   @id @default(cuid())
  projectId String?
  invoiceId String?
  userId    String
  action    String   // e.g. "CREATED_PROJECT", "UPDATED_STATUS", "COMMENTED", "CREATED_INVOICE", "UPDATED_INVOICE"
  details   String?  // JSON string or simple text for extra details

  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Document {
  id          String   @id @default(cuid())
  workspaceId String
  projectId   String?
  name        String
  url         String
  fileType    String?
  size        Int?     // in bytes

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProjectMember {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  role        String   @default("MEMBER") // Optional: specific project role
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt    DateTime @default(now())

  @@unique([projectId, userId])
}

model Task {
  id          String       @id @default(cuid())
  workspaceId String
  projectId   String
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  
  dueDate     DateTime?
  startDate   DateTime?
  completedAt DateTime?

  assignedUserId String?
  assignedUser   User?   @relation(fields: [assignedUserId], references: [id])
  
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  reminders   Reminder[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([projectId])
  @@index([status])
  @@index([assignedUserId])
}

model Team {
  id          String   @id @default(cuid())
  workspaceId String
  projectId   String?
  name        String
  description String?

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project     Project?  @relation(fields: [projectId], references: [id])
  members     TeamMember[]
  invoices    Invoice[]
  payments    Payment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([projectId])
}

model TeamMember {
  id         String  @id @default(cuid())
  teamId     String
  name       String
  contact    String?
  occupation String?
  address    String?

  team       Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([teamId])
}

model Invitation {
  id          String   @id @default(cuid())
  workspaceId String
  email       String?
  token       String   @unique
  role        Role     @default(TEAM_MEMBER)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  @@index([workspaceId])
  @@index([token])
}

model Expense {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  category    String   // e.g. "Office", "Salaries", "Equipment"
  amount      Decimal  @db.Decimal(15, 2)
  date        DateTime @default(now())
  receiptUrl  String?
  
  // Relation to Workspace
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([workspaceId])
}

model Reminder {
  id          String   @id @default(cuid())
  taskId      String?
  projectId   String?
  frequency   String   // "DAILY", "WEEKLY"
  lastSentAt  DateTime?
  
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([taskId])
  @@index([projectId])
}

// Force regenerate

